View(alldata)
alldata <- alldata |> mutate(tim = as.Date(year=year, month=month,day=day) )
alldata <- alldata |> mutate(tim = lubridate::as_date(year=year, month=month,day=day) )
alldata <- alldata |> mutate(tim = as.Date(paste0(year,month,day, sep='-')) )
paste0(year,month,day, sep='-')
alldata <- alldata |> mutate(tim = as.Date(paste(year,month,day, sep='-')) )
View(alldata)
alldata <- alldata |> mutate(tim = as.Date(paste(year,month,day, sep='-'))) |> subset(!is.na(tim))
View(alldata)
alldata <- alldata |> mutate(tim = as.Date(paste(year,month,day, sep='-'))) |> subset(!is.na(tim)) |> arrange(id, tim)
cdata.all <- alldata |> left_join(cdata.tl, by=join_by(id==id,year==year,month==month, day==day))
View(cdata.all)
cdata.all <- alldata |> left_join(cdata.th, by=join_by(id==id,year==year,month==month, day==day)) |> left_join(cdata.tl, by=join_by(id==id,year==year,month==month, day==day)) |> left_join(cdata.p, by=join_by(id==id,year==year,month==month, day==day))
View(alldata)
View(xfilter)
stations <- xfilter1 |> subset(select = c(id, latitude, longitude, elevation, state, name)) |> unique()
stations <- xfilter |> subset(select = c(id, latitude, longitude, elevation, state, name)) |> unique()
View(stations)
alldata <- alldata |> left_join(stations, by=join_by(id=id))
View(alldata)
xfilter <- x |> subset(latitude > 42.9500-0.5 & latitude < 42.9500+0.5 & longitude > -85.6667 - 0.75 & longitude < -85.6667 + 0.75 & elevation > 0 & last_year - first_year > 5  & element %in% 'TMAX') |> mutate(time = last_year - first_year)
xfilter1 <- xfilter$id |> unique()
stations <- xfilter |> subset(select = c(id, latitude, longitude, elevation, state, name)) |> unique()
daynum <- c(1:31)
valnum <- paste0('VALUE', daynum)
cdata <- ghcnd(xfilter1)
cdata2 <- subset(cdata, element %in% c('TMAX', 'TMIN', 'PRCP'))
alldata <- unique(subset(cdata2, select=c('id', 'year', 'month')))
datanum.tab <- data.frame(day=daynum)
alldata <- merge(alldata, datanum.tab)
alldata <- alldata |> mutate(tim = as.Date(paste(year,month,day, sep='-'))) |> subset(!is.na(tim)) |> arrange(id, tim)
alldata <- alldata |> left_join(stations, by=join_by(id==id))
View(alldata)
colnames(alldata)
colnames(alldata) <- c("id","state","name","latitude","longitude","elevation","year","month","day","tim")
xfilter1 <- xfilter$id |> unique()
stations <- xfilter |> subset(select = c(id, latitude, longitude, elevation, state, name)) |> unique()
daynum <- c(1:31)
valnum <- paste0('VALUE', daynum)
cdata <- ghcnd(xfilter1)
cdata2 <- subset(cdata, element %in% c('TMAX', 'TMIN', 'PRCP'))
alldata <- unique(subset(cdata2, select=c('id', 'year', 'month')))
datanum.tab <- data.frame(day=daynum)
alldata <- merge(alldata, datanum.tab)
alldata <- alldata |> mutate(tim = as.Date(paste(year,month,day, sep='-'))) |> subset(!is.na(tim)) |> arrange(id, tim)
alldata <- alldata |> left_join(stations, by=join_by(id==id))
alldata <- alldata[,c("id","state","name","latitude","longitude","elevation","year","month","day","tim")]
View(alldata)
alldata <- alldata[,c("id","state","name","latitude","longitude","elevation","tim","year","month","day")]
for(i in 1:31){#i=1
cdata.tl0 <-  cbind(subset(cdata2, element %in% c('TMIN'), select = c('id', 'year', 'month', valnum[i])) , day=i)
cdata.th0 <-  cbind(subset(cdata2, element %in% c('TMAX'), select = c('id', 'year', 'month', valnum[i])) , day=i)
cdata.p0 <-  cbind(subset(cdata2, element %in% c('PRCP'), select = c('id', 'year', 'month', valnum[i])) , day=i)
names(cdata.tl0) <- c('id', 'year', 'month','tl','day')
names(cdata.th0) <- c('id', 'year', 'month','th','day')
names(cdata.p0) <- c('id', 'year', 'month','p','day')
if(i==1){
cdata.tl=cdata.tl0
cdata.th=cdata.th0
cdata.p=cdata.p0
}else{
cdata.tl=rbind(cdata.tl,cdata.tl0)
cdata.th=rbind(cdata.th,cdata.th0)
cdata.p=rbind(cdata.p,cdata.p0)
}
}
cdata.all <- alldata |> left_join(cdata.th, by=join_by(id==id,year==year,month==month, day==day)) |> left_join(cdata.tl, by=join_by(id==id,year==year,month==month, day==day)) |> left_join(cdata.p, by=join_by(id==id,year==year,month==month, day==day))
View(cdata.all)
cdata.all <- cdata.all |> mutate(th = th/10, tl=tl/10)
View(cdata.all)
cdata <- ghcnd('USW00094860', refresh = TRUE)
View(cdata)
cdata <- ghcnd('USC00206013', refresh = TRUE)
View(cdata)
cdata <- ghcnd(xfilter1)
# cdata <- ghcnd('USC00206013', refresh = TRUE)
stations <- xfilter |> subset(select = c(id, latitude, longitude, elevation, state, name)) |> unique()
daynum <- c(1:31)
valnum <- paste0('VALUE', daynum)
cdata2 <- subset(cdata, element %in% c('TMAX', 'TMIN', 'PRCP'))
alldata <- unique(subset(cdata2, select=c('id', 'year', 'month')))
datanum.tab <- data.frame(day=daynum)
alldata <- merge(alldata, datanum.tab)
alldata <- alldata |> mutate(tim = as.Date(paste(year,month,day, sep='-'))) |> subset(!is.na(tim)) |> arrange(id, tim)
alldata <- alldata |> left_join(stations, by=join_by(id==id))
alldata <- alldata[,c("id","state","name","latitude","longitude","elevation","tim","year","month","day")]
for(i in 1:31){#i=1
cdata.tl0 <-  cbind(subset(cdata2, element %in% c('TMIN'), select = c('id', 'year', 'month', valnum[i])) , day=i)
cdata.th0 <-  cbind(subset(cdata2, element %in% c('TMAX'), select = c('id', 'year', 'month', valnum[i])) , day=i)
cdata.p0 <-  cbind(subset(cdata2, element %in% c('PRCP'), select = c('id', 'year', 'month', valnum[i])) , day=i)
names(cdata.tl0) <- c('id', 'year', 'month','tl','day')
names(cdata.th0) <- c('id', 'year', 'month','th','day')
names(cdata.p0) <- c('id', 'year', 'month','p','day')
if(i==1){
cdata.tl=cdata.tl0
cdata.th=cdata.th0
cdata.p=cdata.p0
}else{
cdata.tl=rbind(cdata.tl,cdata.tl0)
cdata.th=rbind(cdata.th,cdata.th0)
cdata.p=rbind(cdata.p,cdata.p0)
}
}
cdata.all <- alldata |> left_join(cdata.th, by=join_by(id==id,year==year,month==month, day==day)) |> left_join(cdata.tl, by=join_by(id==id,year==year,month==month, day==day)) |> left_join(cdata.p, by=join_by(id==id,year==year,month==month, day==day))
cdata.all <- cdata.all |> mutate(th = th/10, tl=tl/10)
View(cdata.all)
cdata.all <- cdata.all |> mutate(t = (th+tl)/2)
View(cdata.all)
cdata.all <- cdata.all |> mutate(t = (th+tl)/2, decyear = lubridate::decimal_date(tim))
View(cdata.all)
cdata.all <- cdata.all |> mutate(t = (th+tl)/2, decyear = lubridate::decimal_date(tim), sindat = sin(decyear*2*3.141592))
cdata.all <- cdata.all |> mutate(t = (th+tl)/2, decyear = lubridate::decimal_date(tim), sindat = sin(decyear*2*3.141592),cosdat = cos(decyear*2*3.141592))
library(ranger)
train <- cdata.all |> subset(!is.na(t))
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat,
data=train)
View(stations)
View(cdata)
View(x)
View(xfilter)
fitpoints <- cdata.all |>  subset(id %in% 'USW00094860')
View(fitpoints)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, id, latitude, longitude, elevation, state, name))
View(fitstat)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
View(fittime)
fitdat <- merge(fitstat, fittime)
View(fitdat)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
View(fitdat)
fitdat <- fitdat |> mutate(t.rf = predictions(rf, fitdat))
fitdat <- fitdat |> mutate(t.rf = predict(rf, fitdat))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat,
data=train, min.node.size = 1, num.trees = 200)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
View(train)
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat,
data=train, min.node.size = 1, num.trees = 200, sample.fraction = 1)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
View(fittime)
View(fitdat)
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat,
data=train, min.node.size = 1, num.trees = 200, sample.fraction = 1, min.bucket = 1)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
mod <- lm(t ~ latitude+longitude+elevation+decyear+sindat+cosdat,
data=train)
summary(mod)
mod <- lm(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+id,
data=train)
summary(mod)
train <- train |> mutate(t.lm = predict(mod, train))
View(train)
train <- cdata.all |> subset(!is.na(t))
mod <- lm(t ~ latitude+longitude+elevation+decyear+sindat+cosdat,
data=train)
summary(mod)
train <- train |> mutate(t.lm = predict(mod, train))
train <- train |> mutate(t.lm = predict(mod, train))
View(train)
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+t.lm,
data=train, min.node.size = 1, num.trees = 200, sample.fraction = 1, min.bucket = 1)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat), t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+t.lm+id,
data=train, min.node.size = 1, num.trees = 200, sample.fraction = 1, min.bucket = 1)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
mod <- lm(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+id,
data=train)
summary(mod)
train <- train |> mutate(t.lm = predict(mod, train))
rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+t.lm,
data=train, min.node.size = 1, num.trees = 200, sample.fraction = 1, min.bucket = 1)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat))
fitdat <- fitdat |> mutate(t.rf = predictions(predict(rf, fitdat)))
View(fitdat)
ggplot(data=fitdat, aes(x=decyear, y=t))+
geom_smooth()
ggplot(data=fitdat, aes(x=decyear, y=t))+
geom_point(alpha=0.1)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-1/12))
View(fitsum)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.161))
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.162))
View(fitsum)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t, na.rm=T))
View(fitsum)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t.rf, na.rm=T))
View(rf)
View(fitsum)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t.rf, na.rm=T)) |> subset(year2 > 1891)
ggplot(data=fitsum, aes(x=year2))+
geom_line(aes(y=summer), color='red')+
geom_line(aes(y=winter), color='blue')+
geom_line(aes(y=annual), color='black')
library(data.table)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5))
View(fitsum)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
geom_point(aes(y=winter), color='blue')+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=summ5yr), color='red')+
geom_line(aes(y=wint5yr), color='blue')+
geom_line(aes(y=ann5yr), color='black')
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
geom_point(aes(y=winter), color='blue')+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=summ5yr), color='red')+
geom_line(aes(y=wint5yr), color='blue')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'temperature (C)')+
scale_x_continuous(name = 'year')
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'temperature (C)')+
scale_x_continuous(name = 'year')
c(0:12)*10
(c(0:12)*10+1900)
(c(-1:13)*10+1900)
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t.rf, na.rm=T)) |> subset(year2 > 1892)
library(data.table)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
geom_line(aes(y=summ5yr), color='red')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
geom_line(aes(y=wint5yr), color='blue')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), winter2 = ifelse(month %in% c(1,2,12), t,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t.rf, na.rm=T)) |> subset(year2 > 1892)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), winter2 = ifelse(month %in% c(1,2,12), t,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA), summer2 = ifelse(month %in% c(6,7,8), t,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t.rf, na.rm=T),  winter2 = mean(winter2, na.rm=T),  summer2 = mean(summer2, na.rm=T)) |> subset(year2 > 1892)
library(data.table)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
train <- cdata.all |> subset(!is.na(t))
mod <- lm(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+id,
data=train)
summary(mod)
# train <- train |> mutate(t.lm = predict(mod, train))
# rf <- ranger(t ~ latitude+longitude+elevation+decyear+sindat+cosdat+t.lm,
#              data=train, min.node.size = 1, num.trees = 200, sample.fraction = 1, min.bucket = 1)
train <- train |> mutate(t.lm = predict(mod, fitdat))
train <- train |> mutate(t.lm = predict(mod, train))
View(x)
View(stations)
View(xfilter)
gr.resids <- train |> subset(grepl('Grand Rapids', name)) |> mutate(resid = t-t.lm)
gr.resids <- train |> subset(grepl('GRAND RAPIDS', name)) |> mutate(resid = t-t.lm)
View(gr.resids)
gr.resids <- gr.resids |> group_by(decyear) |> summarise(resid = mean(resid))
View(gr.resids)
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> group_by(gr.resids)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> left_join(gr.resids)
View(fitdat)
gr.resids <- train |> mutate(resid = t-t.lm)
gr.resids <- gr.resids |> group_by(decyear) |> summarise(resid = mean(resid))
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> left_join(gr.resids)
View(fitdat)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> left_join(gr.resids) |> mutate(oldt = t, t=resid+t.lm)
View(fitdat)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t.rf,NA), winter2 = ifelse(month %in% c(1,2,12), t,NA), summer = ifelse(month %in% c(6,7,8), t.rf,NA), summer2 = ifelse(month %in% c(6,7,8), t,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t.rf, na.rm=T),  winter2 = mean(winter2, na.rm=T),  summer2 = mean(summer2, na.rm=T)) |> subset(year2 > 1892)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> left_join(gr.resids) |> mutate(oldt = t, t=resid+t.lm)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t,NA), winter2 = ifelse(month %in% c(1,2,12), oldt,NA), summer = ifelse(month %in% c(6,7,8), t,NA), summer2 = ifelse(month %in% c(6,7,8), oldt,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t, na.rm=T),  winter2 = mean(winter2, na.rm=T),  summer2 = mean(summer2, na.rm=T)) |> subset(year2 > 1892)
library(data.table)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
# geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
# geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 10), summ5yr = frollmean(summer, 10), wint5yr = frollmean(winter, 10))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
# geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
# geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='black')+
geom_line(aes(y=ann5yr), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
# geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
# geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
# geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
geom_smooth(aes(y=winter), color='black')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='green')+
geom_line(aes(y=ann5yr), color='green')+
geom_smooth(aes(y=annual), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='darkgreen')+
geom_line(aes(y=ann5yr), color='darkgreen')+
geom_smooth(aes(y=annual), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
# geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
geom_smooth(aes(y=summer), color='black')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
View(fitdat)
View(train)
gr.resids <- train |> mutate(resid = t-t.lm) |> subset(grepl('GRAND RAPIDS', name))
gr.resids <- gr.resids |> group_by(decyear) |> summarise(resid = mean(resid))
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> left_join(gr.resids) |> mutate(oldt = t, t=resid+t.lm)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t,NA), winter2 = ifelse(month %in% c(1,2,12), oldt,NA), summer = ifelse(month %in% c(6,7,8), t,NA), summer2 = ifelse(month %in% c(6,7,8), oldt,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t, na.rm=T),  winter2 = mean(winter2, na.rm=T),  summer2 = mean(summer2, na.rm=T)) |> subset(year2 > 1892)
library(data.table)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='darkgreen')+
geom_line(aes(y=ann5yr), color='darkgreen')+
geom_smooth(aes(y=annual), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
# geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
geom_smooth(aes(y=summer), color='black')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
# geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
geom_smooth(aes(y=winter), color='black')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
gr.resids <- train |> mutate(resid = t-t.lm) #|> subset(grepl('GRAND RAPIDS', name))
gr.resids <- gr.resids |> group_by(decyear) |> summarise(resid = mean(resid))
fitstat <- stations |>  subset(id %in% 'USW00094860', select = c(id, latitude, longitude, elevation, state, name))
fittime <- cdata.all |> subset(select = c(year, month, day, decyear, sindat, cosdat)) |> unique() |> arrange(decyear)
fitdat <- merge(fitstat, fittime) |> left_join(train[,c("id", "decyear", "t")], by=join_by(id==id, decyear==decyear))
fitdat <- fitdat |> mutate(t.lm = predict(mod, fitdat)) |> left_join(gr.resids) |> mutate(oldt = t, t=resid+t.lm)
fitsum <- fitdat |> mutate(winter = ifelse(month %in% c(1,2,12), t,NA), winter2 = ifelse(month %in% c(1,2,12), oldt,NA), summer = ifelse(month %in% c(6,7,8), t,NA), summer2 = ifelse(month %in% c(6,7,8), oldt,NA),
year2 = floor(decyear-0.1615)) |> group_by(year2) |> summarise(summer = mean(summer, na.rm=T), winter = mean(winter, na.rm=T),  annual = mean(t, na.rm=T),  winter2 = mean(winter2, na.rm=T),  summer2 = mean(summer2, na.rm=T)) |> subset(year2 > 1892)
library(data.table)
fitsum <- fitsum |> mutate(ann5yr = frollmean(annual, 5), summ5yr = frollmean(summer, 5), wint5yr = frollmean(winter, 5))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=annual), color='darkgreen')+
geom_line(aes(y=ann5yr), color='darkgreen')+
geom_smooth(aes(y=annual), color='black')+
scale_y_continuous(name = 'annual temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=summer), color='red')+
# geom_point(aes(y=summer2), color='black')+
geom_line(aes(y=summ5yr), color='red')+
geom_smooth(aes(y=summer), color='black')+
scale_y_continuous(name = 'summer temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
ggplot(data=fitsum, aes(x=year2))+
geom_point(aes(y=winter), color='blue')+
# geom_point(aes(y=winter2), color='black')+
geom_line(aes(y=wint5yr), color='blue')+
geom_smooth(aes(y=winter), color='black')+
scale_y_continuous(name = 'winter temperature (C)')+
scale_x_continuous(name = 'year', breaks = (c(-1:13)*10+1900))
shiny::runApp('C:/workspace2/StationClimR2')
runApp('C:/workspace2/StationClimR2')
shiny::runApp()
